<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Results</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Add no-js class initially, JS will remove it -->
    <script>document.documentElement.className = 'js-enabled';</script>
</head>
<!-- Add no-js class for fallback styling -->
<body class="no-js">
    <div class="container">
        <h1>Risk Assessment Results</h1>

        <!-- Grid Layout Container for Score/Factors/Suggestions -->
        <div class="results-layout-grid">

            <!-- Area 1: Score (Left Column) -->
            <div class="results-score-area">
                <h2>Your Estimated Risk Score:</h2>
                <!-- Dynamically set class based on score -->
                {% set risk_level = 'high' if risk_score >= 60 else ('medium' if risk_score >= 30 else 'low') %}
                <div class="risk-score {{ risk_level }}">{{ "%.1f"|format(risk_score|float) }}%</div>
                <p>(Model's estimated probability)</p>
            </div>

            <!-- Area 2: Factors (Top Right) -->
            <div class="results-factors-area">
                <h3>
                    Contributing Factors
                    <!-- Ensure gemini_logo.png is in static folder -->
                    <img src="{{ url_for('static', filename='gemini_logo.png') }}" alt="AI Generated" class="gemini-logo" title="Generated by AI">
                </h3>
                <!-- Placeholder shown while JS types -->
                <div id="factors-generating" class="generating-indicator">
                    Generating factors... <span class="spinner"></span>
                </div>
                <!-- List where factors will be typed -->
                <ul id="factors-list">
                    <!-- Static fallback content (visible if JS disabled/fails or AI error) -->
                    {% if not contributing_factors or contributing_factors[0] == "Error generating AI suggestions." or contributing_factors[0] == "AI suggestions disabled." %}
                         <li><i>AI suggestions not available. Please consult a healthcare provider.</i></li>
                    {% else %}
                        {% for factor in contributing_factors %}
                            <li>{{ factor }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>

            <!-- Area 3: Suggestions (Bottom Right) -->
             <div class="results-suggestions-area">
                 <h3>
                    Suggested Considerations
                    <img src="{{ url_for('static', filename='gemini_logo.png') }}" alt="AI Generated" class="gemini-logo" title="Generated by AI">
                </h3>
                 <!-- Placeholder shown while JS types -->
                <div id="suggestions-generating" class="generating-indicator">
                    Generating suggestions... <span class="spinner"></span>
                </div>
                <!-- List where suggestions will be typed -->
                <ul id="suggestions-list">
                    <!-- Static fallback content -->
                     {% if not suggested_improvements or suggested_improvements[0] == "Could not connect to the suggestion service. Please consult a healthcare provider." or suggested_improvements[0] == "Please consult a healthcare provider for personalized advice." %}
                          <li><i>AI suggestions not available. Please consult a healthcare provider.</i></li>
                     {% else %}
                        {% for suggestion in suggested_improvements %}
                            <li>{{ suggestion }}</li>
                        {% endfor %}
                     {% endif %}
                </ul>
            </div>

        </div> <!-- Close results-layout-grid -->

        <!-- Disclaimer and Actions remain outside the main results grid -->
         <div class="disclaimer">
            <strong>Disclaimer:</strong> This is an educational tool based on a statistical model and AI suggestions. It does <strong>not</strong> provide a medical diagnosis or replace professional medical advice. Risk factors are complex and individual health varies. Always consult a qualified healthcare provider for any health concerns, diagnosis, or before making any decisions related to your health or treatment.
        </div>

        <div class="results-actions">
             <!-- Link styled as a button -->
             <a href="{{ url_for('home') }}" class="button-link">Assess Again</a>
        </div>

    </div> <!-- Close container -->

    <!-- JavaScript Section for Typing Effect -->
    <script>
        // Helper function for delay using Promises
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Main function to type out list items word by word
        async function typeListWordByWord(listId, generatingId, items, wordDelay = 50, itemDelay = 200) {
            const listElement = document.getElementById(listId);
            const generatingElement = document.getElementById(generatingId);

            // Basic validation: Check if elements exist and data is valid (not null/empty/error message)
            const hasError = !items || items.length === 0 || (items[0] && (items[0].includes("Error") || items[0].includes("disabled") || items[0].includes("not available") || items[0].includes("Could not connect")));

            if (!listElement || !generatingElement || hasError) {
                // If elements missing or data contains error, hide indicator and show static fallback
                 if(generatingElement) generatingElement.style.display = 'none';
                 if(listElement) listElement.style.display = 'block'; // Show fallback content inside UL
                console.warn(`Skipping typing effect for ${listId} due to missing elements, data, or error message.`);
                return; // Stop processing for this list
            }

            // Hide "generating" indicator and clear static content
            generatingElement.style.display = 'none';
            listElement.innerHTML = ''; // Clear fallback content from UL
            listElement.style.display = 'block'; // Make list container visible

            try {
                // Loop through each item (factor or suggestion)
                for (const itemText of items) {
                    if (!itemText) continue; // Skip empty items just in case

                    const listItem = document.createElement('li');
                    listElement.appendChild(listItem);
                    // Split carefully, handling potential extra spaces
                    const words = itemText.trim().split(/\s+/).filter(word => word.length > 0);

                    // Loop through words of the current item
                    for (let i = 0; i < words.length; i++) {
                        // Use textContent for security instead of innerHTML if just adding text
                        listItem.textContent += words[i] + (i === words.length - 1 ? '' : ' '); // Add space except for last word
                        await delay(wordDelay); // Pause between words
                    }
                    await delay(itemDelay); // Pause between list items
                }
            } catch (error) {
                console.error(`Error during typing effect for ${listId}:`, error);
                // Optionally display an error message in the list element
                listElement.innerHTML = '<li>An error occurred displaying suggestions.</li>';
            }
        }

        // --- Run the typing effect when the page content is loaded ---
        document.addEventListener('DOMContentLoaded', async () => {
             // Ensure JS class is set correctly after DOM loaded
             document.body.classList.remove('no-js');
             document.body.classList.add('js-enabled');

            // Get data passed from Flask (using Jinja's tojson filter for safety)
            const factorsData = {{ contributing_factors | tojson | safe }};
            const suggestionsData = {{ suggested_improvements | tojson | safe }};

            console.log("Factors data received by JS:", factorsData);
            console.log("Suggestions data received by JS:", suggestionsData);

            // Initial delay before starting the animations (optional)
            await delay(500); // 0.5 second delay

            // Start typing factors first, wait for it to complete
            await typeListWordByWord('factors-list', 'factors-generating', factorsData, 50, 200); // Adjust speeds

            // Then start typing suggestions
            await typeListWordByWord('suggestions-list', 'suggestions-generating', suggestionsData, 50, 200);

             console.log("Typing effect sequence complete.");
        });

    </script>

</body>
</html>